<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeepSeek API èŠå¤©å·¥å…·ï¼ˆå¸¦CORSä»£ç†ï¼‰</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background-color: #f0f2f5;
            color: #333;
            line-height: 1.6;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            color: white;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        
        .header h1 {
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .header p {
            opacity: 0.9;
            max-width: 700px;
            margin: 0 auto;
        }
        
        .container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        @media (min-width: 768px) {
            .container {
                flex-direction: row;
            }
        }
        
        .sidebar {
            background-color: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            flex: 1;
        }
        
        .chat-container {
            background-color: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            flex: 2;
            display: flex;
            flex-direction: column;
        }
        
        .section-title {
            font-size: 18px;
            color: #333;
            margin-bottom: 15px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .section-title i {
            color: #667eea;
        }
        
        .api-key-container {
            margin-bottom: 25px;
        }
        
        input[type="text"], input[type="password"], select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e5eb;
            border-radius: 8px;
            font-size: 16px;
            background-color: white;
            color: #333;
            transition: all 0.3s;
            margin-bottom: 10px;
        }
        
        input[type="text"]:focus, input[type="password"]:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .model-selector {
            margin-bottom: 25px;
        }
        
        .chat-history {
            flex: 1;
            overflow-y: auto;
            max-height: 500px;
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 8px;
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
        }
        
        .message {
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 12px;
            max-width: 85%;
            word-wrap: break-word;
        }
        
        .user-message {
            background-color: #e3f2fd;
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }
        
        .ai-message {
            background-color: #f5f5f5;
            margin-right: auto;
            border-bottom-left-radius: 4px;
            border-left: 4px solid #667eea;
        }
        
        .message-header {
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .user-message .message-header {
            color: #1976d2;
        }
        
        .ai-message .message-header {
            color: #5a67d8;
        }
        
        .message-content {
            line-height: 1.5;
            white-space: pre-wrap;
        }
        
        .input-area {
            display: flex;
            gap: 10px;
        }
        
        #message-input {
            flex: 1;
            padding: 15px;
            border: 2px solid #e1e5eb;
            border-radius: 8px;
            font-size: 16px;
            resize: none;
            height: 60px;
            font-family: inherit;
        }
        
        #send-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 0 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        #send-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        #send-btn:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .status {
            margin-top: 15px;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            font-weight: 500;
            display: none;
        }
        
        .status.connected {
            background-color: #d4edda;
            color: #155724;
            display: block;
        }
        
        .status.disconnected {
            background-color: #f8d7da;
            color: #721c24;
            display: block;
        }
        
        .api-info {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 25px;
            font-size: 14px;
            color: #555;
        }
        
        .api-info h4 {
            color: #333;
            margin-bottom: 8px;
        }
        
        .footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
            color: #666;
            font-size: 14px;
        }
        
        .api-status {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 10px;
        }
        
        .api-status span {
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }
        
        .connected .status-indicator {
            background-color: #28a745;
        }
        
        .disconnected .status-indicator {
            background-color: #dc3545;
        }
        
        .btn {
            padding: 8px 15px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            font-weight: 500;
        }
        
        .btn-secondary {
            background-color: #f1f3f9;
            color: #333;
            border: 1px solid #e1e5eb;
        }
        
        .btn-secondary:hover {
            background-color: #e8ebf3;
        }
        
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 12px 20px;
            background-color: #f5f5f5;
            border-radius: 12px;
            border-bottom-left-radius: 4px;
            width: fit-content;
            margin-right: auto;
            border-left: 4px solid #667eea;
            margin-bottom: 20px;
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #667eea;
            opacity: 0.6;
            animation: typingAnimation 1.4s infinite ease-in-out;
        }
        
        .typing-dot:nth-child(1) {
            animation-delay: -0.32s;
        }
        
        .typing-dot:nth-child(2) {
            animation-delay: -0.16s;
        }
        
        @keyframes typingAnimation {
            0%, 80%, 100% {
                transform: scale(0.8);
                opacity: 0.6;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .model-info {
            margin-top: 15px;
            font-size: 13px;
            color: #666;
        }
        
        .endpoint-container {
            margin-bottom: 20px;
        }
        
        #custom-endpoint {
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>DeepSeek API èŠå¤©å·¥å…·ï¼ˆå¸¦CORSä»£ç†ï¼‰</h1>
        <p>é€šè¿‡ä»£ç†æœåŠ¡å™¨è°ƒç”¨DeepSeek APIï¼Œè§£å†³CORSé™åˆ¶é—®é¢˜</p>
    </div>
    
    <div class="container">
        <div class="sidebar">
            <div class="section-title">
                <span>âš™ï¸</span> API é…ç½®
            </div>
            
            <div class="api-key-container">
                <label for="api-key">DeepSeek API Key:</label>
                <input type="password" id="api-key" placeholder="è¯·è¾“å…¥æ‚¨çš„DeepSeek APIå¯†é’¥">
                <button id="toggle-visibility" class="btn btn-secondary" style="width: 100%; margin-top: 5px;">æ˜¾ç¤º/éšè—APIå¯†é’¥</button>
                
                <div class="api-status">
                    <span id="api-status-text" class="disconnected">
                        <span class="status-indicator"></span>
                        APIå¯†é’¥æœªè®¾ç½®
                    </span>
                </div>
            </div>
            
            <div class="endpoint-container">
                <label for="api-endpoint">APIç«¯ç‚¹:</label>
                <select id="api-endpoint">
                    <option value="direct">ç›´æ¥è°ƒç”¨: https://api.deepseek.com/v1/chat/completions</option>
                    <option value="cors-proxy">ä½¿ç”¨CORSä»£ç†: https://corsproxy.io/?https://api.deepseek.com/v1/chat/completions</option>
                    <option value="allorigins">ä½¿ç”¨AllOriginsä»£ç†: https://api.allorigins.win/raw?url=https://api.deepseek.com/v1/chat/completions</option>
                    <option value="custom">è‡ªå®šä¹‰ä»£ç†...</option>
                </select>
                <input type="text" id="custom-endpoint" placeholder="è¾“å…¥è‡ªå®šä¹‰ä»£ç†URL" style="display:none; margin-top:10px;">
                <div class="model-info">
                    å¦‚æœç›´æ¥è°ƒç”¨å¤±è´¥ï¼Œè¯·å°è¯•ä½¿ç”¨CORSä»£ç†
                </div>
            </div>
            
            <div class="model-selector">
                <label for="model-select">é€‰æ‹©æ¨¡å‹:</label>
                <select id="model-select">
                    <option value="deepseek-chat">deepseek-chat</option>
                    <option value="deepseek-coder">deepseek-coder</option>
                </select>
                <div class="model-info">
                    æ¨èä½¿ç”¨ deepseek-chat è¿›è¡Œå¯¹è¯
                </div>
            </div>
            
            <div class="api-info">
                <h4>å…³äºCORSä»£ç†</h4>
                <p>ç”±äºæµè§ˆå™¨å®‰å…¨é™åˆ¶ï¼Œç›´æ¥ä»å‰ç«¯è°ƒç”¨APIå¯èƒ½è¢«é˜»æ­¢ã€‚</p>
                <p>ä»£ç†æœåŠ¡å™¨å¯ä»¥å¸®åŠ©è½¬å‘è¯·æ±‚ï¼Œè§£å†³CORSé—®é¢˜ã€‚</p>
                <p><strong>æ³¨æ„ï¼š</strong>ä»£ç†æœåŠ¡å™¨å¯èƒ½ä¼šçœ‹åˆ°æ‚¨çš„APIå¯†é’¥å’Œå¯¹è¯å†…å®¹ï¼Œè¯·è°¨æ…ä½¿ç”¨ã€‚</p>
            </div>
            
            <div class="controls">
                <button id="clear-chat-btn" class="btn btn-secondary" style="flex:1;">
                    æ¸…ç©ºå¯¹è¯
                </button>
                <button id="test-api-btn" class="btn btn-secondary" style="flex:1;">
                    æµ‹è¯•è¿æ¥
                </button>
            </div>
        </div>
        
        <div class="chat-container">
            <div class="section-title">
                <span>ğŸ’¬</span> å¯¹è¯çª—å£
            </div>
            
            <div class="chat-history" id="chat-history">
                <div class="message ai-message">
                    <div class="message-header">
                        <span>ğŸ¤–</span> DeepSeek AI
                    </div>
                    <div class="message-content">
                        æ‚¨å¥½ï¼æˆ‘æ˜¯DeepSeek AIåŠ©æ‰‹ã€‚è¯·å…ˆåœ¨å·¦ä¾§é…ç½®æ‚¨çš„APIå¯†é’¥å’Œä»£ç†é€‰é¡¹ã€‚
                        
                        å¦‚æœç›´æ¥è°ƒç”¨APIé‡åˆ°CORSé—®é¢˜ï¼Œè¯·é€‰æ‹©CORSä»£ç†é€‰é¡¹ã€‚
                        
                        æ¨èæ­¥éª¤ï¼š
                        1. è¾“å…¥æ‚¨çš„DeepSeek APIå¯†é’¥
                        2. é€‰æ‹©APIç«¯ç‚¹ï¼ˆå…ˆå°è¯•ç›´æ¥è°ƒç”¨ï¼Œå¦‚æœå¤±è´¥å†å°è¯•ä»£ç†ï¼‰
                        3. ç‚¹å‡»"æµ‹è¯•è¿æ¥"éªŒè¯é…ç½®
                        4. åœ¨ä¸‹æ–¹è¾“å…¥æ¡†å‘é€æ¶ˆæ¯
                    </div>
                </div>
            </div>
            
            <div class="input-area">
                <textarea id="message-input" placeholder="è¾“å…¥æ‚¨çš„æ¶ˆæ¯... (æŒ‰Shift+Enteræ¢è¡Œï¼ŒæŒ‰Enterå‘é€)"></textarea>
                <button id="send-btn">å‘é€</button>
            </div>
            
            <div class="status disconnected" id="connection-status">
                <span id="status-text">è¯·å…ˆé…ç½®APIå¯†é’¥ä»¥å¼€å§‹å¯¹è¯</span>
            </div>
        </div>
    </div>
    
    <div class="footer">
        <p>DeepSeek API èŠå¤©å·¥å…·ï¼ˆå¸¦CORSä»£ç†ï¼‰ | çœŸå®APIè°ƒç”¨ï¼Œéæ¨¡æ‹Ÿ</p>
        <p>æ³¨æ„ï¼šä»£ç†æœåŠ¡å™¨ä»…ç”¨äºè§£å†³CORSé—®é¢˜ï¼Œè¯·å‹¿ç”¨äºæ•æ„Ÿå¯¹è¯</p>
    </div>

    <script>
        // åˆå§‹åŒ–å˜é‡
        let chatHistory = [];
        let currentModel = 'deepseek-chat';
        let apiKey = '';
        let isConnected = false;
        let conversationContext = [];
        
        // DOMå…ƒç´ 
        const modelSelect = document.getElementById('model-select');
        const apiKeyInput = document.getElementById('api-key');
        const apiEndpointSelect = document.getElementById('api-endpoint');
        const customEndpointInput = document.getElementById('custom-endpoint');
        const chatHistoryElement = document.getElementById('chat-history');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-btn');
        const connectionStatus = document.getElementById('connection-status');
        const statusText = document.getElementById('status-text');
        const apiStatusText = document.getElementById('api-status-text');
        const testApiBtn = document.getElementById('test-api-btn');
        const clearChatBtn = document.getElementById('clear-chat-btn');
        const toggleVisibilityBtn = document.getElementById('toggle-visibility');
        
        // ç«¯ç‚¹æ˜ å°„
        const endpointMap = {
            'direct': 'https://api.deepseek.com/v1/chat/completions',
            'cors-proxy': 'https://corsproxy.io/?https://api.deepseek.com/v1/chat/completions',
            'allorigins': 'https://api.allorigins.win/raw?url=https://api.deepseek.com/v1/chat/completions',
            'custom': ''
        };
        
        // è·å–å½“å‰ç«¯ç‚¹
        function getCurrentEndpoint() {
            const selected = apiEndpointSelect.value;
            
            if (selected === 'custom') {
                return customEndpointInput.value;
            }
            
            return endpointMap[selected];
        }
        
        // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
        function initEventListeners() {
            // æ¨¡å‹é€‰æ‹©å˜åŒ–
            modelSelect.addEventListener('change', function() {
                currentModel = this.value;
                checkConnection();
            });
            
            // APIå¯†é’¥è¾“å…¥å˜åŒ–
            apiKeyInput.addEventListener('input', function() {
                apiKey = this.value.trim();
                checkConnection();
            });
            
            // ç«¯ç‚¹é€‰æ‹©å˜åŒ–
            apiEndpointSelect.addEventListener('change', function() {
                if (this.value === 'custom') {
                    customEndpointInput.style.display = 'block';
                } else {
                    customEndpointInput.style.display = 'none';
                }
                checkConnection();
            });
            
            // è‡ªå®šä¹‰ç«¯ç‚¹è¾“å…¥å˜åŒ–
            customEndpointInput.addEventListener('input', function() {
                checkConnection();
            });
            
            // åˆ‡æ¢APIå¯†é’¥å¯è§æ€§
            toggleVisibilityBtn.addEventListener('click', function() {
                const type = apiKeyInput.getAttribute('type');
                if (type === 'password') {
                    apiKeyInput.setAttribute('type', 'text');
                    this.textContent = 'éšè—APIå¯†é’¥';
                } else {
                    apiKeyInput.setAttribute('type', 'password');
                    this.textContent = 'æ˜¾ç¤ºAPIå¯†é’¥';
                }
            });
            
            // å‘é€æ¶ˆæ¯
            sendButton.addEventListener('click', sendMessage);
            
            // è¾“å…¥æ¡†é”®ç›˜äº‹ä»¶
            messageInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            // æµ‹è¯•APIè¿æ¥
            testApiBtn.addEventListener('click', testApiConnection);
            
            // æ¸…ç©ºèŠå¤©è®°å½•
            clearChatBtn.addEventListener('click', clearChatHistory);
            
            // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æœ¬åœ°å­˜å‚¨
            window.addEventListener('load', loadFromLocalStorage);
        }
        
        // æ£€æŸ¥è¿æ¥çŠ¶æ€
        function checkConnection() {
            const hasApiKey = apiKey.length > 0;
            const endpoint = getCurrentEndpoint();
            const hasEndpoint = endpoint && endpoint.trim().length > 0;
            
            if (hasApiKey && apiKey.startsWith('sk-') && hasEndpoint) {
                isConnected = true;
                apiStatusText.className = 'connected';
                apiStatusText.innerHTML = `<span class="status-indicator"></span> APIé…ç½®æ­£ç¡®`;
                connectionStatus.className = 'status connected';
                statusText.textContent = `DeepSeek ${currentModel} å·²å‡†å¤‡å°±ç»ª`;
                sendButton.disabled = false;
            } else if (hasApiKey && !apiKey.startsWith('sk-')) {
                isConnected = false;
                apiStatusText.className = 'disconnected';
                apiStatusText.innerHTML = `<span class="status-indicator"></span> APIå¯†é’¥æ ¼å¼ä¸æ­£ç¡®`;
                connectionStatus.className = 'status disconnected';
                statusText.textContent = 'APIå¯†é’¥åº”ä»¥"sk-"å¼€å¤´ï¼Œè¯·æ£€æŸ¥æ‚¨çš„å¯†é’¥';
                sendButton.disabled = true;
            } else if (!hasApiKey) {
                isConnected = false;
                apiStatusText.className = 'disconnected';
                apiStatusText.innerHTML = `<span class="status-indicator"></span> APIå¯†é’¥æœªè®¾ç½®`;
                connectionStatus.className = 'status disconnected';
                statusText.textContent = 'è¯·è¾“å…¥æ‚¨çš„DeepSeek APIå¯†é’¥';
                sendButton.disabled = true;
            } else if (!hasEndpoint) {
                isConnected = false;
                apiStatusText.className = 'disconnected';
                apiStatusText.innerHTML = `<span class="status-indicator"></span> APIç«¯ç‚¹æœªè®¾ç½®`;
                connectionStatus.className = 'status disconnected';
                statusText.textContent = 'è¯·é€‰æ‹©æˆ–è¾“å…¥APIç«¯ç‚¹';
                sendButton.disabled = true;
            }
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            saveToLocalStorage();
        }
        
        // æµ‹è¯•APIè¿æ¥
        async function testApiConnection() {
            if (!apiKey) {
                alert('è¯·è¾“å…¥APIå¯†é’¥');
                return;
            }
            
            if (!apiKey.startsWith('sk-')) {
                alert('APIå¯†é’¥æ ¼å¼ä¸æ­£ç¡®ï¼Œåº”ä»¥"sk-"å¼€å¤´');
                return;
            }
            
            const endpoint = getCurrentEndpoint();
            if (!endpoint) {
                alert('è¯·é€‰æ‹©æˆ–è¾“å…¥APIç«¯ç‚¹');
                return;
            }
            
            // æ˜¾ç¤ºæµ‹è¯•çŠ¶æ€
            connectionStatus.className = 'status disconnected';
            statusText.textContent = 'æ­£åœ¨æµ‹è¯•APIè¿æ¥...';
            sendButton.disabled = true;
            
            try {
                // æµ‹è¯•è¯·æ±‚
                const testResponse = await callDeepSeekAPI([
                    { role: "user", content: "è¯·å›å¤ä¸€ä¸ªç®€å•çš„'è¿æ¥æµ‹è¯•æˆåŠŸ'æ¶ˆæ¯ï¼Œä¸éœ€è¦å…¶ä»–å†…å®¹ã€‚" }
                ], true);
                
                if (testResponse) {
                    connectionStatus.className = 'status connected';
                    statusText.textContent = `âœ… è¿æ¥æµ‹è¯•æˆåŠŸï¼DeepSeek ${currentModel} å·²å°±ç»ª`;
                    sendButton.disabled = false;
                    
                    // æ·»åŠ æµ‹è¯•æˆåŠŸçš„æ¶ˆæ¯
                    addMessage('ai', 'âœ… è¿æ¥æµ‹è¯•æˆåŠŸï¼æˆ‘å·²ç»å‡†å¤‡å¥½ä¸ºæ‚¨æä¾›å¸®åŠ©äº†ã€‚æœ‰ä»€ä¹ˆé—®é¢˜æƒ³è¦å’¨è¯¢å—ï¼Ÿ');
                    
                    // ä¿å­˜é…ç½®åˆ°æœ¬åœ°å­˜å‚¨
                    saveToLocalStorage();
                }
            } catch (error) {
                connectionStatus.className = 'status disconnected';
                statusText.textContent = `âŒ è¿æ¥æµ‹è¯•å¤±è´¥: ${error.message}`;
                sendButton.disabled = true;
                
                // æ·»åŠ æµ‹è¯•å¤±è´¥çš„æ¶ˆæ¯
                let errorMsg = `âŒ è¿æ¥æµ‹è¯•å¤±è´¥: ${error.message}`;
                
                // æ ¹æ®é”™è¯¯ç±»å‹æä¾›å»ºè®®
                if (error.message.includes('CORS') || error.message.includes('Failed to fetch')) {
                    errorMsg += '\n\nå»ºè®®ï¼š\n1. å°è¯•åˆ‡æ¢ä¸åŒçš„CORSä»£ç†é€‰é¡¹\n2. å®‰è£…CORSè§£é™¤æµè§ˆå™¨æ‰©å±•\n3. æ£€æŸ¥ç½‘ç»œè¿æ¥';
                } else if (error.message.includes('401') || error.message.includes('æƒé™')) {
                    errorMsg += '\n\nå»ºè®®ï¼š\n1. æ£€æŸ¥APIå¯†é’¥æ˜¯å¦æ­£ç¡®\n2. ç¡®è®¤APIå¯†é’¥æ˜¯å¦æœ‰è¶³å¤Ÿçš„æƒé™';
                }
                
                addMessage('ai', errorMsg);
            }
        }
        
        // è°ƒç”¨DeepSeek API
        async function callDeepSeekAPI(messages, isTest = false) {
            const endpoint = getCurrentEndpoint();
            
            const requestBody = {
                model: currentModel,
                messages: messages,
                max_tokens: 2000,
                temperature: 0.7,
                stream: false
            };
            
            // å¯¹äºä»£ç†ç«¯ç‚¹ï¼Œéœ€è¦ç‰¹æ®Šå¤„ç†è¯·æ±‚
            let finalEndpoint = endpoint;
            let headers = {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${apiKey}`,
                'Accept': 'application/json'
            };
            
            // å¤„ç†ä¸åŒçš„ä»£ç†ç±»å‹
            if (endpoint.includes('corsproxy.io')) {
                // corsproxy.io éœ€è¦å°†è¯·æ±‚ä½“æ”¾åœ¨URLä¸­
                finalEndpoint = endpoint;
                // corsproxy.io è‡ªåŠ¨å¤„ç†CORSï¼Œä¸éœ€è¦ç‰¹æ®Šå¤´
            } else if (endpoint.includes('allorigins.win')) {
                // allorigins.win ä»£ç†
                finalEndpoint = endpoint;
            }
            
            try {
                const response = await fetch(finalEndpoint, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(requestBody)
                });
                
                if (!response.ok) {
                    let errorMessage = `HTTPé”™è¯¯: ${response.status}`;
                    
                    try {
                        const errorData = await response.json();
                        if (errorData.error && errorData.error.message) {
                            errorMessage = errorData.error.message;
                        }
                    } catch (e) {
                        // å¦‚æœæ— æ³•è§£æJSONï¼Œä½¿ç”¨çŠ¶æ€æ–‡æœ¬
                        errorMessage = `${response.status}: ${response.statusText}`;
                    }
                    
                    throw new Error(errorMessage);
                }
                
                const data = await response.json();
                
                if (isTest) {
                    return data;
                }
                
                if (data.choices && data.choices.length > 0 && data.choices[0].message) {
                    return data.choices[0].message.content;
                } else {
                    throw new Error('APIå“åº”æ ¼å¼ä¸æ­£ç¡®');
                }
            } catch (error) {
                // å¦‚æœæ˜¯ç½‘ç»œé”™è¯¯ï¼Œæä¾›æ›´å‹å¥½çš„æç¤º
                if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
                    throw new Error('ç½‘ç»œé”™è¯¯ï¼šæ— æ³•è¿æ¥åˆ°APIã€‚è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–å°è¯•ä¸åŒçš„ä»£ç†é€‰é¡¹');
                }
                throw error;
            }
        }
        
        // å‘é€æ¶ˆæ¯
        async function sendMessage() {
            const message = messageInput.value.trim();
            
            if (!message) {
                alert('è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹');
                return;
            }
            
            if (!isConnected) {
                alert('è¯·å…ˆé…ç½®æœ‰æ•ˆçš„APIå¯†é’¥å’Œç«¯ç‚¹');
                return;
            }
            
            // ç§»é™¤æ¬¢è¿æ¶ˆæ¯
            const welcomeMsg = document.querySelector('.welcome-message');
            if (welcomeMsg) {
                welcomeMsg.remove();
            }
            
            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°èŠå¤©è®°å½•
            addMessage('user', message);
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            messageInput.value = '';
            
            // æ·»åŠ åˆ°å¯¹è¯ä¸Šä¸‹æ–‡
            conversationContext.push({ role: "user", content: message });
            
            // é™åˆ¶ä¸Šä¸‹æ–‡é•¿åº¦ï¼Œé¿å…tokenè¶…é™
            if (conversationContext.length > 10) {
                conversationContext = conversationContext.slice(-10);
            }
            
            // æ˜¾ç¤º"æ­£åœ¨è¾“å…¥"çŠ¶æ€
            showTypingIndicator();
            
            try {
                // è°ƒç”¨DeepSeek API
                const aiResponse = await callDeepSeekAPI(conversationContext);
                
                // æ·»åŠ åˆ°å¯¹è¯ä¸Šä¸‹æ–‡
                conversationContext.push({ role: "assistant", content: aiResponse });
                
                // æ·»åŠ AIå“åº”åˆ°èŠå¤©è®°å½•
                addMessage('ai', aiResponse);
            } catch (error) {
                // ç§»é™¤"æ­£åœ¨è¾“å…¥"çŠ¶æ€
                hideTypingIndicator();
                
                // æ·»åŠ é”™è¯¯æ¶ˆæ¯
                let errorMsg = `âŒ APIè°ƒç”¨å¤±è´¥: ${error.message}`;
                
                // æ ¹æ®é”™è¯¯ç±»å‹æä¾›å»ºè®®
                if (error.message.includes('CORS') || error.message.includes('ç½‘ç»œé”™è¯¯')) {
                    errorMsg += '\n\nå»ºè®®ï¼š\n1. å°è¯•åˆ‡æ¢ä¸åŒçš„CORSä»£ç†é€‰é¡¹\n2. å®‰è£…CORSè§£é™¤æµè§ˆå™¨æ‰©å±•\n3. æ£€æŸ¥ç½‘ç»œè¿æ¥';
                } else if (error.message.includes('401') || error.message.includes('æƒé™')) {
                    errorMsg += '\n\nå»ºè®®ï¼š\n1. æ£€æŸ¥APIå¯†é’¥æ˜¯å¦æ­£ç¡®\n2. ç¡®è®¤APIå¯†é’¥æ˜¯å¦æœ‰è¶³å¤Ÿçš„æƒé™\n3. ç¡®è®¤APIå¯†é’¥æ˜¯å¦å·²æ¿€æ´»';
                } else if (error.message.includes('429')) {
                    errorMsg += '\n\nå»ºè®®ï¼š\n1. è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•\n2. æ£€æŸ¥APIä½¿ç”¨é¢åº¦æ˜¯å¦å·²ç”¨å®Œ';
                }
                
                addMessage('ai', errorMsg);
                
                console.error('APIè°ƒç”¨é”™è¯¯:', error);
            }
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            saveToLocalStorage();
        }
        
        // æ˜¾ç¤º"æ­£åœ¨è¾“å…¥"çŠ¶æ€
        function showTypingIndicator() {
            const typingElement = document.createElement('div');
            typingElement.className = 'typing-indicator';
            typingElement.id = 'typing-indicator';
            typingElement.innerHTML = `
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <span style="margin-left: 8px; color: #666; font-size: 0.9rem;">DeepSeek ${currentModel} æ­£åœ¨æ€è€ƒ...</span>
            `;
            
            chatHistoryElement.appendChild(typingElement);
            chatHistoryElement.scrollTop = chatHistoryElement.scrollHeight;
        }
        
        // éšè—"æ­£åœ¨è¾“å…¥"çŠ¶æ€
        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }
        
        // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©ç•Œé¢
        function addMessage(sender, content) {
            // å…ˆéšè—"æ­£åœ¨è¾“å…¥"çŠ¶æ€
            hideTypingIndicator();
            
            const messageId = Date.now();
            const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            // ä¿å­˜åˆ°å†å²è®°å½•
            chatHistory.push({
                id: messageId,
                sender: sender,
                content: content,
                timestamp: timestamp,
                model: sender === 'ai' ? currentModel : null
            });
            
            // åˆ›å»ºæ¶ˆæ¯å…ƒç´ 
            const messageElement = document.createElement('div');
            messageElement.className = `message ${sender === 'user' ? 'user-message' : 'ai-message'}`;
            
            const senderName = sender === 'user' ? 'æ‚¨' : `DeepSeek ${currentModel}`;
            
            messageElement.innerHTML = `
                <div class="message-header">
                    <span>${sender === 'user' ? 'ğŸ‘¤' : 'ğŸ¤–'}</span> ${senderName}
                    <span style="margin-left: auto; font-size: 12px; color: #999;">${timestamp}</span>
                </div>
                <div class="message-content">${formatMessageContent(content)}</div>
            `;
            
            // æ·»åŠ åˆ°èŠå¤©å†å²
            chatHistoryElement.appendChild(messageElement);
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            chatHistoryElement.scrollTop = chatHistoryElement.scrollHeight;
        }
        
        // æ ¼å¼åŒ–æ¶ˆæ¯å†…å®¹
        function formatMessageContent(content) {
            // å°†æ¢è¡Œè½¬æ¢ä¸º<br>
            let formatted = content.replace(/\n/g, '<br>');
            
            // ç®€å•Markdownæ ¼å¼è½¬æ¢
            // åŠ ç²—ï¼š**æ–‡æœ¬** -> <strong>æ–‡æœ¬</strong>
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            // ä»£ç ï¼š`ä»£ç ` -> <code>ä»£ç </code>
            formatted = formatted.replace(/`(.*?)`/g, '<code>$1</code>');
            
            return formatted;
        }
        
        // æ¸…ç©ºèŠå¤©è®°å½•
        function clearChatHistory() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰èŠå¤©è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
                chatHistory = [];
                conversationContext = [];
                
                // æ¸…ç©ºèŠå¤©ç•Œé¢
                chatHistoryElement.innerHTML = `
                    <div class="message ai-message">
                        <div class="message-header">
                            <span>ğŸ¤–</span> DeepSeek AI
                        </div>
                        <div class="message-content">
                            å¯¹è¯è®°å½•å·²æ¸…ç©ºã€‚è¯·åœ¨ä¸‹æ–¹çš„è¾“å…¥æ¡†ä¸­è¾“å…¥æ‚¨çš„é—®é¢˜ã€‚
                        </div>
                    </div>
                `;
                
                // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                saveToLocalStorage();
            }
        }
        
        // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
        function saveToLocalStorage() {
            const data = {
                chatHistory: chatHistory,
                currentModel: currentModel,
                apiKey: apiKey,
                conversationContext: conversationContext,
                endpoint: apiEndpointSelect.value,
                customEndpoint: customEndpointInput.value
            };
            localStorage.setItem('deepseekChatData', JSON.stringify(data));
        }
        
        // ä»æœ¬åœ°å­˜å‚¨åŠ è½½
        function loadFromLocalStorage() {
            const savedData = localStorage.getItem('deepseekChatData');
            
            if (savedData) {
                try {
                    const data = JSON.parse(savedData);
                    
                    // æ¢å¤æ¨¡å‹é€‰æ‹©
                    if (data.currentModel) {
                        currentModel = data.currentModel;
                        modelSelect.value = currentModel;
                    }
                    
                    // æ¢å¤APIå¯†é’¥
                    if (data.apiKey) {
                        apiKey = data.apiKey;
                        apiKeyInput.value = apiKey;
                    }
                    
                    // æ¢å¤ç«¯ç‚¹é€‰æ‹©
                    if (data.endpoint) {
                        apiEndpointSelect.value = data.endpoint;
                        if (data.endpoint === 'custom') {
                            customEndpointInput.style.display = 'block';
                        }
                    }
                    
                    // æ¢å¤è‡ªå®šä¹‰ç«¯ç‚¹
                    if (data.customEndpoint) {
                        customEndpointInput.value = data.customEndpoint;
                    }
                    
                    // æ¢å¤å¯¹è¯ä¸Šä¸‹æ–‡
                    if (data.conversationContext) {
                        conversationContext = data.conversationContext;
                    }
                    
                    // æ¢å¤èŠå¤©è®°å½•
                    if (data.chatHistory && data.chatHistory.length > 0) {
                        chatHistory = data.chatHistory;
                        
                        // æ¸…ç©ºå½“å‰èŠå¤©ç•Œé¢
                        chatHistoryElement.innerHTML = '';
                        
                        // é‡æ–°æ·»åŠ æ¶ˆæ¯
                        chatHistory.forEach(msg => {
                            const messageElement = document.createElement('div');
                            messageElement.className = `message ${msg.sender === 'user' ? 'user-message' : 'ai-message'}`;
                            
                            const senderName = msg.sender === 'user' ? 'æ‚¨' : `DeepSeek ${msg.model || currentModel}`;
                            
                            messageElement.innerHTML = `
                                <div class="message-header">
                                    <span>${msg.sender === 'user' ? 'ğŸ‘¤' : 'ğŸ¤–'}</span> ${senderName}
                                    <span style="margin-left: auto; font-size: 12px; color: #999;">${msg.timestamp}</span>
                                </div>
                                <div class="message-content">${formatMessageContent(msg.content)}</div>
                            `;
                            
                            chatHistoryElement.appendChild(messageElement);
                        });
                    }
                    
                    // æ£€æŸ¥è¿æ¥çŠ¶æ€
                    checkConnection();
                    
                } catch (e) {
                    console.error('åŠ è½½æœ¬åœ°å­˜å‚¨æ•°æ®å¤±è´¥:', e);
                }
            }
        }
        
        // åˆå§‹åŒ–åº”ç”¨
        function initApp() {
            initEventListeners();
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>