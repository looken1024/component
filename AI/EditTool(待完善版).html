<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EditPlus风格文本编辑器</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f5dc;
            color: #333;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* 工具栏样式 */
        .toolbar {
            background-color: #fff9c4;
            padding: 8px 16px;
            border-bottom: 1px solid #e6d8a0;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            z-index: 10;
        }

        .toolbar-btn {
            background-color: #fff;
            color: #333;
            border: 1px solid #d4c690;
            border-radius: 4px;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .toolbar-btn:hover {
            background-color: #f0f0f0;
            border-color: #b8a86c;
        }

        .toolbar-btn:active {
            background-color: #e0e0e0;
        }

        .toolbar-separator {
            width: 1px;
            height: 24px;
            background-color: #d4c690;
            margin: 0 8px;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-left: auto;
            font-size: 14px;
        }

        .filename-input {
            background-color: #fff;
            border: 1px solid #d4c690;
            color: #333;
            padding: 4px 8px;
            border-radius: 4px;
            min-width: 200px;
        }

        .language-select {
            background-color: #fff;
            border: 1px solid #d4c690;
            color: #333;
            padding: 4px 8px;
            border-radius: 4px;
        }

        /* 主编辑区 */
        .editor-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .line-numbers {
            background-color: #f0e6b3;
            color: #666;
            padding: 12px 8px 12px 12px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            text-align: right;
            user-select: none;
            overflow-y: hidden;
            width: 60px;
            flex-shrink: 0;
            border-right: 1px solid #d4c690;
            display: flex;
            flex-direction: column;
            min-height: 100%;
        }

        .line-number {
            height: 21px; /* 14px * 1.5 = 21px */
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 4px;
            white-space: nowrap;
        }

        .editor-wrapper {
            flex: 1;
            position: relative;
            overflow: auto;
            background-color: #ffffe0;
        }

        #editor {
            background-color: #ffffe0;
            color: #333;
            caret-color: #333;
            padding: 12px 16px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            white-space: pre;
            overflow-wrap: normal;
            outline: none;
            width: 100%;
            min-height: 100%;
            resize: none;
            tab-size: 4;
            -moz-tab-size: 4;
            border: none;
            overflow: auto;
        }

        /* 简单的高亮样式 */
        .keyword { color: #0000ff; font-weight: bold; }
        .string { color: #008000; }
        .comment { color: #808080; font-style: italic; }
        .number { color: #ff4500; }
        .function { color: #8b008b; }
        .operator { color: #0000cc; }
        .punctuation { color: #333; }
        .property { color: #ff00ff; }

        /* 状态栏 */
        .status-bar {
            background-color: #e6d8a0;
            color: #333;
            padding: 4px 16px;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
            border-top: 1px solid #d4c690;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* 文件输入隐藏 */
        #file-input {
            display: none;
        }

        /* 滚动条样式 */
        ::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }

        ::-webkit-scrollbar-track {
            background: #f0e6b3;
        }

        ::-webkit-scrollbar-thumb {
            background: #d4c690;
            border-radius: 6px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #b8a86c;
        }

        /* 响应式调整 */
        @media (max-width: 768px) {
            .toolbar {
                padding: 6px 10px;
            }
            
            .toolbar-btn span {
                display: none;
            }
            
            .filename-input {
                min-width: 150px;
            }
        }
    </style>
</head>
<body>
    <!-- 工具栏 -->
    <div class="toolbar">
        <button id="new-btn" class="toolbar-btn">
            <i class="fas fa-file"></i><span>新建</span>
        </button>
        <button id="open-btn" class="toolbar-btn">
            <i class="fas fa-folder-open"></i><span>打开</span>
        </button>
        <button id="save-btn" class="toolbar-btn">
            <i class="fas fa-save"></i><span>保存</span>
        </button>
        <button id="save-as-btn" class="toolbar-btn">
            <i class="fas fa-save"></i><span>另存为</span>
        </button>
        
        <div class="toolbar-separator"></div>
        
        <button id="undo-btn" class="toolbar-btn">
            <i class="fas fa-undo"></i><span>撤销</span>
        </button>
        <button id="redo-btn" class="toolbar-btn">
            <i class="fas fa-redo"></i><span>重做</span>
        </button>
        
        <div class="toolbar-separator"></div>
        
        <button id="find-btn" class="toolbar-btn">
            <i class="fas fa-search"></i><span>查找</span>
        </button>
        
        <div class="file-info">
            <input type="text" id="filename" class="filename-input" placeholder="未命名文件.txt" value="未命名文件.txt">
            <select id="language" class="language-select">
                <option value="plain">纯文本</option>
                <option value="html">HTML</option>
                <option value="css">CSS</option>
                <option value="javascript">JavaScript</option>
                <option value="python">Python</option>
            </select>
        </div>
    </div>
    
    <!-- 文件输入 -->
    <input type="file" id="file-input" accept=".txt,.html,.css,.js,.py">
    
    <!-- 主编辑区 -->
    <div class="editor-container">
        <div class="line-numbers" id="line-numbers"></div>
        <div class="editor-wrapper">
            <div id="editor" contenteditable="true" spellcheck="false"></div>
        </div>
    </div>
    
    <!-- 状态栏 -->
    <div class="status-bar">
        <div class="status-item">
            <span id="cursor-position">行: 1, 列: 1</span>
            <span id="tab-info">Tab: 4空格</span>
        </div>
        <div class="status-item">
            <span id="char-count">字符: 0</span>
            <span id="language-status">语言: 纯文本</span>
        </div>
    </div>

    <script>
        // 获取DOM元素
        const editor = document.getElementById('editor');
        const lineNumbers = document.getElementById('line-numbers');
        const fileInput = document.getElementById('file-input');
        const filenameInput = document.getElementById('filename');
        const languageSelect = document.getElementById('language');
        const cursorPosition = document.getElementById('cursor-position');
        const charCount = document.getElementById('char-count');
        const languageStatus = document.getElementById('language-status');
        const tabInfo = document.getElementById('tab-info');
        
        // 编辑器状态
        let currentFile = null;
        let isModified = false;
        let highlightTimeout = null;
        
        // 初始化编辑器
        function initEditor() {
            // 设置初始内容
            const initialContent = `欢迎使用类EditPlus文本编辑器！

功能说明：
1. 支持打开、编辑、保存文本文件
2. 支持多种编程语言的语法高亮
3. Tab键插入4个空格
4. 浅黄色背景，黑色文字

请使用上方工具栏开始编辑。`;
            
            editor.textContent = initialContent;
            updateLineNumbers();
            updateStatus();
            
            // 使用MutationObserver监听编辑器内容变化
            const observer = new MutationObserver(function(mutations) {
                isModified = true;
                updateLineNumbers();
                updateStatus();
                debouncedApplyHighlighting();
            });
            
            // 配置观察器
            observer.observe(editor, {
                childList: true,
                subtree: true,
                characterData: true
            });
            
            // 监听编辑器输入
            editor.addEventListener('input', function(e) {
                isModified = true;
                updateLineNumbers();
                updateStatus();
                debouncedApplyHighlighting();
            });
            
            // 监听光标移动
            editor.addEventListener('keyup', updateStatus);
            editor.addEventListener('mouseup', updateStatus);
            editor.addEventListener('click', updateStatus);
            
            // 处理Tab键缩进（4个空格）
            editor.addEventListener('keydown', function(e) {
                // Tab键处理 - 插入4个空格
                if (e.key === 'Tab') {
                    e.preventDefault();
                    
                    // 保存当前选区
                    const sel = window.getSelection();
                    const range = sel.getRangeAt(0);
                    
                    // 插入4个空格
                    const textNode = document.createTextNode('    ');
                    range.deleteContents();
                    range.insertNode(textNode);
                    
                    // 移动光标到插入的文本之后
                    range.setStartAfter(textNode);
                    range.setEndAfter(textNode);
                    sel.removeAllRanges();
                    sel.addRange(range);
                    
                    return;
                }
                
                // Enter键处理 - 自动缩进
                if (e.key === 'Enter') {
                    e.preventDefault();
                    
                    // 保存当前选区
                    const sel = window.getSelection();
                    const range = sel.getRangeAt(0);
                    
                    // 获取当前行的缩进
                    let indentCount = 0;
                    const text = editor.textContent;
                    const cursorPos = getCursorPositionInText();
                    
                    if (text && cursorPos !== undefined) {
                        // 找到当前行的开始位置
                        let lineStart = 0;
                        for (let i = cursorPos - 1; i >= 0; i--) {
                            if (text[i] === '\n') {
                                lineStart = i + 1;
                                break;
                            }
                        }
                        
                        // 获取当前行的文本（从行开始到光标位置）
                        const lineText = text.substring(lineStart, cursorPos);
                        
                        // 计算当前行的空格缩进
                        for (let i = 0; i < lineText.length; i++) {
                            if (lineText[i] === ' ') {
                                indentCount++;
                            } else if (lineText[i] === '\t') {
                                indentCount += 4; // 将制表符视为4个空格
                            } else {
                                break;
                            }
                        }
                    }
                    
                    // 创建要插入的文本（换行 + 缩进）
                    const textToInsert = '\n' + ' '.repeat(indentCount);
                    
                    // 使用execCommand插入文本
                    document.execCommand('insertText', false, textToInsert);
                    
                    return;
                }
                
                // 撤销/重做处理 (Ctrl+Z / Ctrl+Y)
                if (e.ctrlKey || e.metaKey) {
                    if (e.key === 'z') {
                        e.preventDefault();
                        document.execCommand('undo');
                    } else if (e.key === 'y') {
                        e.preventDefault();
                        document.execCommand('redo');
                    } else if (e.key === 's') {
                        e.preventDefault();
                        saveFile();
                    }
                }
            });
            
            // 语言选择变化
            languageSelect.addEventListener('change', function() {
                applyHighlighting();
                languageStatus.textContent = `语言: ${languageSelect.options[languageSelect.selectedIndex].text}`;
            });
            
            // 初始化高亮
            applyHighlighting();
            
            // 同步滚动
            editor.addEventListener('scroll', function() {
                lineNumbers.scrollTop = editor.scrollTop;
            });
        }
        
        // 获取光标在纯文本中的位置
        function getCursorPositionInText() {
            const selection = window.getSelection();
            if (selection.rangeCount === 0) return 0;
            
            const range = selection.getRangeAt(0);
            
            // 简单方法：通过遍历DOM节点计算光标位置
            let position = 0;
            const walker = document.createTreeWalker(
                editor, 
                NodeFilter.SHOW_TEXT | NodeFilter.SHOW_ELEMENT,
                {
                    acceptNode: function(node) {
                        if (node.nodeType === Node.TEXT_NODE) {
                            return NodeFilter.FILTER_ACCEPT;
                        }
                        if (node.nodeType === Node.ELEMENT_NODE && node.tagName === 'BR') {
                            return NodeFilter.FILTER_ACCEPT;
                        }
                        return NodeFilter.FILTER_SKIP;
                    }
                }, 
                false
            );
            
            let node;
            while (node = walker.nextNode()) {
                if (node === range.endContainer) {
                    if (node.nodeType === Node.TEXT_NODE) {
                        position += range.endOffset;
                    }
                    break;
                }
                
                if (node.nodeType === Node.TEXT_NODE) {
                    position += node.textContent.length;
                } else if (node.nodeType === Node.ELEMENT_NODE && node.tagName === 'BR') {
                    position += 1;
                }
            }
            
            return position;
        }
        
        // 防抖应用高亮
        function debouncedApplyHighlighting() {
            clearTimeout(highlightTimeout);
            highlightTimeout = setTimeout(() => {
                applyHighlighting();
            }, 100);
        }
        
        // 语法高亮规则
        const highlightRules = {
            javascript: {
                keywords: /\b(function|var|let|const|if|else|for|while|return|new|class|extends|import|export|from|default|true|false|null|undefined|typeof|instanceof|this)\b/g,
                strings: /(["'`])(?:\\(?:\r\n|[\s\S])|(?!\1)[^\\\r\n])*\1/g,
                comments: /\/\/.*|\/\*[\s\S]*?\*\//g,
                numbers: /\b\d+(?:\.\d+)?\b/g,
                functions: /\b\w+(?=\()/g
            },
            html: {
                tags: /<\/?[\w\s="'-]+>?/g,
                comments: /<!--[\s\S]*?-->/g,
                attributes: /\b(\w+)=/g
            },
            css: {
                properties: /\b[\w-]+(?=\s*:)/g,
                values: /:\s*[^;]+/g,
                selectors: /[^{}]+(?=\{)/g,
                comments: /\/\*[\s\S]*?\*\//g
            },
            python: {
                keywords: /\b(def|class|if|elif|else|for|while|try|except|import|from|as|with|return|yield|lambda|and|or|not|in|is|None|True|False)\b/g,
                strings: /(["'`])(?:\\(?:\r\n|[\s\S])|(?!\1)[^\\\r\n])*\1/g,
                comments: /#.*/g,
                numbers: /\b\d+(?:\.\d+)?\b/g,
                functions: /\b\w+(?=\()/g
            }
        };
        
        // 应用语法高亮
        function applyHighlighting() {
            const language = languageSelect.value;
            
            // 如果是纯文本，直接返回
            if (language === 'plain') {
                return;
            }
            
            // 获取当前纯文本
            const text = editor.textContent;
            
            // 应用语法高亮
            let highlighted = escapeHtml(text);
            const rules = highlightRules[language];
            
            if (rules) {
                // 应用注释高亮
                if (rules.comments) {
                    highlighted = highlighted.replace(rules.comments, '<span class="comment">$&</span>');
                }
                
                // 应用字符串高亮
                if (rules.strings) {
                    highlighted = highlighted.replace(rules.strings, '<span class="string">$&</span>');
                }
                
                // 应用关键字高亮
                if (rules.keywords) {
                    highlighted = highlighted.replace(rules.keywords, '<span class="keyword">$&</span>');
                }
                
                // 应用数字高亮
                if (rules.numbers) {
                    highlighted = highlighted.replace(rules.numbers, '<span class="number">$&</span>');
                }
                
                // 应用函数高亮
                if (rules.functions) {
                    highlighted = highlighted.replace(rules.functions, '<span class="function">$&</span>');
                }
                
                // HTML标签高亮
                if (rules.tags) {
                    highlighted = highlighted.replace(rules.tags, '<span class="keyword">$&</span>');
                }
                
                // CSS属性高亮
                if (rules.properties) {
                    highlighted = highlighted.replace(rules.properties, '<span class="property">$&</span>');
                }
            }
            
            // 将换行符转换为<br>标签以便显示
            highlighted = highlighted.replace(/\n/g, '<br>');
            
            // 更新编辑器内容
            editor.innerHTML = highlighted;
            
            // 更新行号以确保与高亮后的内容对齐
            updateLineNumbers();
        }
        
        // 转义HTML特殊字符
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // 更新行号
        function updateLineNumbers() {
            // 获取编辑器文本
            const text = editor.textContent;
            
            // 按换行符分割文本
            const lines = text.split('\n');
            
            // 清空行号区域
            lineNumbers.innerHTML = '';
            
            // 为每一行创建一个行号元素
            for (let i = 1; i <= lines.length; i++) {
                const lineNumber = document.createElement('div');
                lineNumber.className = 'line-number';
                lineNumber.textContent = i;
                lineNumbers.appendChild(lineNumber);
            }
            
            // 确保行号区域有足够的高度
            lineNumbers.style.minHeight = editor.scrollHeight + 'px';
            
            // 同步滚动位置
            lineNumbers.scrollTop = editor.scrollTop;
        }
        
        // 更新状态栏
        function updateStatus() {
            // 计算光标位置
            const text = editor.textContent;
            const cursorPos = getCursorPositionInText();
            
            // 计算行和列
            let line = 1;
            let column = 1;
            
            for (let i = 0; i < cursorPos && i < text.length; i++) {
                if (text[i] === '\n') {
                    line++;
                    column = 1;
                } else {
                    column++;
                }
            }
            
            cursorPosition.textContent = `行: ${line}, 列: ${column}`;
            
            // 字符计数
            charCount.textContent = `字符: ${text.length}`;
            
            // 修改状态
            document.title = (isModified ? '* ' : '') + filenameInput.value + ' - 文本编辑器';
        }
        
        // 文件操作
        // 新建文件
        document.getElementById('new-btn').addEventListener('click', function() {
            if (isModified) {
                if (!confirm('当前文件已修改，是否保存更改？')) {
                    resetEditor();
                }
            } else {
                resetEditor();
            }
        });
        
        // 打开文件
        document.getElementById('open-btn').addEventListener('click', function() {
            fileInput.click();
        });
        
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(event) {
                // 直接设置文本内容
                editor.textContent = event.target.result;
                
                currentFile = file;
                filenameInput.value = file.name;
                
                // 根据扩展名设置语言
                const ext = file.name.split('.').pop().toLowerCase();
                if (ext === 'js') languageSelect.value = 'javascript';
                else if (ext === 'html' || ext === 'htm') languageSelect.value = 'html';
                else if (ext === 'css') languageSelect.value = 'css';
                else if (ext === 'py') languageSelect.value = 'python';
                else languageSelect.value = 'plain';
                
                isModified = false;
                applyHighlighting();
                updateLineNumbers();
                updateStatus();
                languageStatus.textContent = `语言: ${languageSelect.options[languageSelect.selectedIndex].text}`;
            };
            
            reader.readAsText(file);
        });
        
        // 保存文件
        document.getElementById('save-btn').addEventListener('click', saveFile);
        
        // 另存为
        document.getElementById('save-as-btn').addEventListener('click', function() {
            saveFile(true);
        });
        
        // 保存文件函数
        function saveFile(forceSaveAs = false) {
            const content = editor.textContent;
            const filename = filenameInput.value || '未命名文件.txt';
            
            // 如果没有文件名或强制另存为，则提示输入文件名
            if (!currentFile || forceSaveAs) {
                const suggestedName = filenameInput.value || '未命名文件.txt';
                const userFilename = prompt('请输入文件名:', suggestedName);
                if (!userFilename) return;
                
                filenameInput.value = userFilename;
            }
            
            // 创建并下载文件
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filenameInput.value;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            isModified = false;
            updateStatus();
            
            // 设置当前文件
            currentFile = { name: filenameInput.value };
        }
        
        // 重置编辑器
        function resetEditor() {
            editor.textContent = '';
            currentFile = null;
            filenameInput.value = '未命名文件.txt';
            languageSelect.value = 'plain';
            isModified = false;
            applyHighlighting();
            updateLineNumbers();
            updateStatus();
            languageStatus.textContent = `语言: 纯文本`;
        }
        
        // 撤销/重做按钮
        document.getElementById('undo-btn').addEventListener('click', function() {
            document.execCommand('undo');
        });
        
        document.getElementById('redo-btn').addEventListener('click', function() {
            document.execCommand('redo');
        });
        
        // 查找功能
        document.getElementById('find-btn').addEventListener('click', function() {
            const searchText = prompt('请输入要查找的文本:');
            if (!searchText) return;
            
            const content = editor.textContent;
            const index = content.indexOf(searchText);
            
            if (index === -1) {
                alert('未找到匹配的文本');
                return;
            }
            
            // 查找匹配的文本节点
            const walker = document.createTreeWalker(editor, NodeFilter.SHOW_TEXT, null, false);
            
            let currentNode;
            let currentIndex = 0;
            let startNode = null;
            let startOffset = 0;
            let found = false;
            
            while (currentNode = walker.nextNode()) {
                const nodeText = currentNode.textContent;
                const nodeLength = nodeText.length;
                
                // 检查搜索文本是否在这个节点中
                if (!found && currentIndex + nodeLength > index) {
                    const localIndex = index - currentIndex;
                    if (nodeText.substring(localIndex, localIndex + searchText.length) === searchText) {
                        startNode = currentNode;
                        startOffset = localIndex;
                        found = true;
                        break;
                    }
                }
                
                currentIndex += nodeLength;
            }
            
            if (startNode) {
                const range = document.createRange();
                range.setStart(startNode, startOffset);
                range.setEnd(startNode, startOffset + searchText.length);
                
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(range);
                
                // 滚动到选中区域
                const rect = range.getBoundingClientRect();
                editor.parentElement.scrollTop += rect.top - 100;
                
                updateStatus();
            }
        });
        
        // 初始化编辑器
        initEditor();
    </script>
</body>
</html>