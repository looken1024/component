<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›¾ç‰‡æ ¼å¼è½¬æ¢å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #333;
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: white;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(135deg, #4b6cb7 0%, #182848 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            font-weight: 300;
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.5;
        }
        
        .main-content {
            display: flex;
            flex-wrap: wrap;
            padding: 30px;
        }
        
        .upload-section {
            flex: 1;
            min-width: 300px;
            padding: 20px;
            border-right: 1px solid #eaeaea;
        }
        
        .conversion-section {
            flex: 1;
            min-width: 300px;
            padding: 20px;
        }
        
        .upload-area {
            border: 3px dashed #4b6cb7;
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            margin-bottom: 20px;
            background-color: #f8faff;
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
        }
        
        .upload-area:hover {
            background-color: #eef2ff;
            border-color: #3a5ca9;
        }
        
        .upload-area.drag-over {
            background-color: #e0e7ff;
            border-color: #2d4b9c;
            border-style: solid;
        }
        
        .upload-icon {
            font-size: 4rem;
            color: #4b6cb7;
            margin-bottom: 15px;
        }
        
        .upload-area h3 {
            margin-bottom: 10px;
            color: #333;
            font-size: 1.4rem;
        }
        
        .upload-area p {
            color: #666;
            margin-bottom: 20px;
            font-size: 0.95rem;
        }
        
        #fileInput {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }
        
        .btn {
            display: inline-block;
            background: linear-gradient(to right, #4b6cb7, #3a5ca9);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s;
            text-align: center;
            box-shadow: 0 4px 10px rgba(75, 108, 183, 0.2);
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(75, 108, 183, 0.3);
        }
        
        .btn:active {
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background: linear-gradient(to right, #2ecc71, #27ae60);
            box-shadow: 0 4px 10px rgba(46, 204, 113, 0.2);
        }
        
        .btn-secondary:hover {
            box-shadow: 0 6px 15px rgba(46, 204, 113, 0.3);
        }
        
        .btn-outline {
            background: transparent;
            border: 2px solid #4b6cb7;
            color: #4b6cb7;
            box-shadow: none;
        }
        
        .btn-outline:hover {
            background-color: #4b6cb7;
            color: white;
            box-shadow: 0 4px 10px rgba(75, 108, 183, 0.2);
        }
        
        .preview-container {
            display: none; /* é»˜è®¤éšè— */
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 20px;
            border: 1px solid #eaeaea;
            background-color: #f9f9f9;
            text-align: center;
            min-height: 200px;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        
        .preview-container.active {
            display: flex; /* ä¸Šä¼ åæ˜¾ç¤º */
        }
        
        #imagePreview {
            max-width: 100%;
            max-height: 300px;
            display: block;
        }
        
        .image-info {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 25px;
            border-left: 4px solid #4b6cb7;
            display: none; /* é»˜è®¤éšè— */
        }
        
        .image-info.active {
            display: block; /* ä¸Šä¼ åæ˜¾ç¤º */
        }
        
        .image-info h3 {
            margin-bottom: 15px;
            color: #333;
            display: flex;
            align-items: center;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px dashed #ddd;
        }
        
        .info-label {
            font-weight: 600;
            color: #555;
        }
        
        .info-value {
            color: #333;
            font-family: monospace;
        }
        
        .format-selector {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 25px;
            border-left: 4px solid #2ecc71;
        }
        
        .format-selector h3 {
            margin-bottom: 20px;
            color: #333;
            display: flex;
            align-items: center;
        }
        
        .format-options {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .format-option {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 20px 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background-color: white;
        }
        
        .format-option:hover {
            border-color: #4b6cb7;
            transform: translateY(-3px);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.05);
        }
        
        .format-option.selected {
            border-color: #2ecc71;
            background-color: #f0fff4;
            box-shadow: 0 5px 15px rgba(46, 204, 113, 0.1);
        }
        
        .format-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
            display: block;
        }
        
        .format-name {
            font-weight: 600;
            margin-bottom: 5px;
            color: #333;
        }
        
        .format-desc {
            font-size: 0.8rem;
            color: #666;
        }
        
        .quality-control {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        
        .quality-control label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #555;
        }
        
        .quality-slider {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        input[type="range"] {
            flex: 1;
            height: 8px;
            border-radius: 4px;
            background: #ddd;
            outline: none;
            -webkit-appearance: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: #2ecc71;
            cursor: pointer;
            border: 3px solid white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        
        .quality-value {
            font-weight: 700;
            color: #2ecc71;
            font-size: 1.2rem;
            min-width: 40px;
            text-align: center;
        }
        
        .conversion-result {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 25px;
            margin-top: 20px;
            border-left: 4px solid #e74c3c;
            display: none;
        }
        
        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .result-header h3 {
            color: #333;
            display: flex;
            align-items: center;
        }
        
        .result-image {
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 20px;
            border: 1px solid #ddd;
            background-color: #f1f1f1;
            text-align: center;
            min-height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #resultPreview {
            max-width: 100%;
            max-height: 200px;
            display: block;
        }
        
        .result-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px dashed #ddd;
        }
        
        .result-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .file-size {
            font-size: 0.9rem;
            color: #666;
            margin-top: 5px;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #4b6cb7;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .status-bar {
            padding: 15px 30px;
            background-color: #e8f4fd;
            font-size: 0.95rem;
            color: #0d47a1;
            border-top: 1px solid #d1e3f8;
        }
        
        .hidden {
            display: none;
        }
        
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .upload-section {
                border-right: none;
                border-bottom: 1px solid #eaeaea;
            }
            
            .format-options {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        .icon {
            display: inline-block;
            width: 24px;
            height: 24px;
            margin-right: 10px;
            vertical-align: middle;
        }
        
        .upload-icon-small {
            font-size: 1.5rem;
            margin-right: 10px;
            vertical-align: middle;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>å›¾ç‰‡æ ¼å¼è½¬æ¢å·¥å…·</h1>
            <p class="subtitle">å¿«é€Ÿã€å®‰å…¨åœ°è½¬æ¢å›¾ç‰‡æ ¼å¼ï¼šPNGã€JPEGã€WEBPã€GIFã€BMPã€TIFFã€ICOç­‰æ ¼å¼ç›¸äº’è½¬æ¢ï¼Œæ‰€æœ‰æ“ä½œå‡åœ¨æµè§ˆå™¨ä¸­å®Œæˆï¼Œä¿æŠ¤æ‚¨çš„éšç§</p>
        </header>
        
        <div class="main-content">
            <div class="upload-section">
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">ğŸ“</div>
                    <h3>ç‚¹å‡»æˆ–æ‹–æ”¾å›¾ç‰‡åˆ°æ­¤å¤„</h3>
                    <p>æ”¯æŒ JPGã€PNGã€WEBPã€GIFã€BMPã€TIFFã€ICO ç­‰æ ¼å¼</p>
                    <p>æœ€å¤§æ–‡ä»¶å¤§å°ï¼š10MB</p>
                    <input type="file" id="fileInput" accept="image/*">
                </div>
                
                <!-- å›¾ç‰‡é¢„è§ˆåŒºåŸŸï¼Œåˆå§‹éšè— -->
                <div class="preview-container" id="previewContainer">
                    <img id="imagePreview" alt="å›¾ç‰‡é¢„è§ˆ">
                </div>
                
                <!-- å›¾ç‰‡ä¿¡æ¯åŒºåŸŸï¼Œåˆå§‹éšè— -->
                <div class="image-info" id="imageInfo">
                    <h3><span class="upload-icon-small">ğŸ“Š</span> å›¾ç‰‡ä¿¡æ¯</h3>
                    <div class="info-row">
                        <span class="info-label">æ–‡ä»¶å:</span>
                        <span class="info-value" id="fileName">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">åŸå§‹æ ¼å¼:</span>
                        <span class="info-value" id="originalFormat">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">å›¾ç‰‡å°ºå¯¸:</span>
                        <span class="info-value" id="imageDimensions">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">æ–‡ä»¶å¤§å°:</span>
                        <span class="info-value" id="fileSize">-</span>
                    </div>
                </div>
            </div>
            
            <div class="conversion-section">
                <div class="format-selector">
                    <h3><span class="upload-icon-small">ğŸ”„</span> è½¬æ¢ä¸ºæ ¼å¼</h3>
                    <p style="color: #666; margin-bottom: 20px;">é€‰æ‹©æ‚¨æƒ³è¦è½¬æ¢çš„ç›®æ ‡æ ¼å¼ï¼š</p>
                    
                    <div class="format-options">
                        <div class="format-option" data-format="png">
                            <span class="format-icon">ğŸ–¼ï¸</span>
                            <div class="format-name">PNG</div>
                            <div class="format-desc">æ— æŸå‹ç¼©ï¼Œæ”¯æŒé€æ˜</div>
                        </div>
                        <div class="format-option" data-format="jpeg">
                            <span class="format-icon">ğŸ“·</span>
                            <div class="format-name">JPEG</div>
                            <div class="format-desc">æœ‰æŸå‹ç¼©ï¼Œé€‚åˆç…§ç‰‡</div>
                        </div>
                        <div class="format-option" data-format="webp">
                            <span class="format-icon">ğŸŒ</span>
                            <div class="format-name">WEBP</div>
                            <div class="format-desc">ç°ä»£æ ¼å¼ï¼Œé«˜å‹ç¼©ç‡</div>
                        </div>
                        <div class="format-option" data-format="gif">
                            <span class="format-icon">ğŸ¬</span>
                            <div class="format-name">GIF</div>
                            <div class="format-desc">æ”¯æŒåŠ¨ç”»ï¼Œ256è‰²</div>
                        </div>
                        <div class="format-option" data-format="bmp">
                            <span class="format-icon">ğŸ’¾</span>
                            <div class="format-name">BMP</div>
                            <div class="format-desc">æ— å‹ç¼©ï¼Œé«˜è´¨é‡</div>
                        </div>
                        <div class="format-option" data-format="ico">
                            <span class="format-icon">ğŸ–¥ï¸</span>
                            <div class="format-name">ICO</div>
                            <div class="format-desc">å›¾æ ‡æ ¼å¼</div>
                        </div>
                    </div>
                    
                    <div class="quality-control" id="qualityControl">
                        <label>JPEG/WEBP è´¨é‡: <span id="qualityValue" class="quality-value">85</span>%</label>
                        <div class="quality-slider">
                            <span style="color: #999; font-size: 0.9rem;">ä½</span>
                            <input type="range" id="qualitySlider" min="10" max="100" value="85">
                            <span style="color: #999; font-size: 0.9rem;">é«˜</span>
                        </div>
                        <p style="font-size: 0.85rem; color: #666; margin-top: 10px;">è´¨é‡è¶Šé«˜ï¼Œæ–‡ä»¶è¶Šå¤§ã€‚PNGæ ¼å¼ä¸å—æ­¤è®¾ç½®å½±å“ã€‚</p>
                    </div>
                    
                    <div style="text-align: center; margin-top: 25px;">
                        <button class="btn btn-secondary" id="convertBtn" disabled>å¼€å§‹è½¬æ¢</button>
                    </div>
                </div>
                
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p>æ­£åœ¨è½¬æ¢å›¾ç‰‡æ ¼å¼ï¼Œè¯·ç¨å€™...</p>
                </div>
                
                <div class="conversion-result" id="conversionResult">
                    <div class="result-header">
                        <h3><span class="upload-icon-small">âœ…</span> è½¬æ¢ç»“æœ</h3>
                        <span id="resultFormat" style="font-weight: 600; color: #2ecc71;"></span>
                    </div>
                    
                    <div class="result-image">
                        <img id="resultPreview" alt="è½¬æ¢ç»“æœé¢„è§ˆ">
                        <div id="noResultMessage" style="color: #999;">
                            è½¬æ¢ç»“æœå°†åœ¨æ­¤å¤„æ˜¾ç¤º
                        </div>
                    </div>
                    
                    <div class="result-info">
                        <div>
                            <div class="info-label">æ–°æ–‡ä»¶å¤§å°:</div>
                            <div class="info-value" id="resultFileSize">-</div>
                        </div>
                        <div>
                            <div class="info-label">å‹ç¼©ç‡:</div>
                            <div class="info-value" id="compressionRatio">-</div>
                        </div>
                    </div>
                    
                    <div class="result-actions">
                        <button class="btn" id="downloadBtn">ä¸‹è½½å›¾ç‰‡</button>
                        <button class="btn btn-outline" id="newConversionBtn">æ–°çš„è½¬æ¢</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="status-bar" id="statusBar">
            <span id="statusMessage">è¯·ä¸Šä¼ å›¾ç‰‡ä»¥å¼€å§‹æ ¼å¼è½¬æ¢</span>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let originalImage = null;
        let originalImageData = null;
        let originalFormat = null;
        let originalFileName = null;
        let originalFileSize = 0;
        let selectedFormat = 'png';
        let quality = 85;
        let conversionResult = null;
        
        // DOMå…ƒç´ 
        const fileInput = document.getElementById('fileInput');
        const uploadArea = document.getElementById('uploadArea');
        const previewContainer = document.getElementById('previewContainer');
        const imagePreview = document.getElementById('imagePreview');
        const imageInfo = document.getElementById('imageInfo');
        const convertBtn = document.getElementById('convertBtn');
        const loading = document.getElementById('loading');
        const conversionResultDiv = document.getElementById('conversionResult');
        const resultPreview = document.getElementById('resultPreview');
        const downloadBtn = document.getElementById('downloadBtn');
        const newConversionBtn = document.getElementById('newConversionBtn');
        const qualitySlider = document.getElementById('qualitySlider');
        const qualityValue = document.getElementById('qualityValue');
        const qualityControl = document.getElementById('qualityControl');
        
        // ä¿¡æ¯æ˜¾ç¤ºå…ƒç´ 
        const fileName = document.getElementById('fileName');
        const originalFormatDisplay = document.getElementById('originalFormat');
        const imageDimensions = document.getElementById('imageDimensions');
        const fileSizeDisplay = document.getElementById('fileSize');
        const resultFormat = document.getElementById('resultFormat');
        const resultFileSize = document.getElementById('resultFileSize');
        const compressionRatio = document.getElementById('compressionRatio');
        
        // çŠ¶æ€æ 
        const statusBar = document.getElementById('statusBar');
        const statusMessage = document.getElementById('statusMessage');
        
        // æ ¼å¼é€‰é¡¹
        const formatOptions = document.querySelectorAll('.format-option');
        
        // åˆå§‹åŒ–
        function init() {
            // æ–‡ä»¶è¾“å…¥æ¡†changeäº‹ä»¶ç›‘å¬
            fileInput.addEventListener('change', handleImageUpload);
            
            // æ‹–æ”¾ä¸Šä¼ 
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('drag-over');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('drag-over');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('drag-over');
                if (e.dataTransfer.files.length) {
                    fileInput.files = e.dataTransfer.files;
                    handleImageUpload();
                }
            });
            
            // æ ¼å¼é€‰æ‹©
            formatOptions.forEach(option => {
                option.addEventListener('click', () => {
                    // ç§»é™¤å…¶ä»–é€‰é¡¹çš„é€‰ä¸­çŠ¶æ€
                    formatOptions.forEach(opt => opt.classList.remove('selected'));
                    // è®¾ç½®å½“å‰é€‰é¡¹ä¸ºé€‰ä¸­çŠ¶æ€
                    option.classList.add('selected');
                    // æ›´æ–°é€‰ä¸­çš„æ ¼å¼
                    selectedFormat = option.dataset.format;
                    
                    // æ›´æ–°è´¨é‡æ§åˆ¶çš„æ˜¾ç¤ºï¼ˆæŸäº›æ ¼å¼ä¸éœ€è¦è´¨é‡æ§åˆ¶ï¼‰
                    updateQualityControlVisibility();
                    
                    // å¦‚æœå·²æœ‰å›¾ç‰‡ï¼Œå¯ç”¨è½¬æ¢æŒ‰é’®
                    if (originalImage) {
                        convertBtn.disabled = false;
                    }
                    
                    updateStatus(`å·²é€‰æ‹© ${selectedFormat.toUpperCase()} æ ¼å¼`);
                });
            });
            
            // è´¨é‡æ»‘å—
            qualitySlider.addEventListener('input', () => {
                quality = parseInt(qualitySlider.value);
                qualityValue.textContent = quality;
            });
            
            // è½¬æ¢æŒ‰é’®
            convertBtn.addEventListener('click', convertImage);
            
            // ä¸‹è½½æŒ‰é’®
            downloadBtn.addEventListener('click', downloadResult);
            
            // æ–°è½¬æ¢æŒ‰é’®
            newConversionBtn.addEventListener('click', resetConversion);
            
            // é»˜è®¤é€‰ä¸­PNGæ ¼å¼
            document.querySelector('.format-option[data-format="png"]').classList.add('selected');
            
            updateStatus('è¯·ä¸Šä¼ å›¾ç‰‡ä»¥å¼€å§‹æ ¼å¼è½¬æ¢');
        }
        
        // å¤„ç†å›¾ç‰‡ä¸Šä¼ 
        function handleImageUpload(e) {
            console.log('handleImageUpload called');
            
            if (!fileInput.files || !fileInput.files.length) {
                console.log('æ²¡æœ‰é€‰æ‹©æ–‡ä»¶');
                return;
            }
            
            const file = fileInput.files[0];
            
            // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆé™åˆ¶10MBï¼‰
            if (file.size > 10 * 1024 * 1024) {
                updateStatus('é”™è¯¯ï¼šæ–‡ä»¶å¤§å°è¶…è¿‡10MBé™åˆ¶', true);
                fileInput.value = ''; // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
                return;
            }
            
            // æ£€æŸ¥æ–‡ä»¶ç±»å‹
            if (!file.type.match('image.*')) {
                updateStatus('é”™è¯¯ï¼šè¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶', true);
                fileInput.value = ''; // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
                return;
            }
            
            // ä¿å­˜åŸå§‹æ–‡ä»¶ä¿¡æ¯
            originalFileName = file.name;
            originalFileSize = file.size;
            originalFormat = getFileExtension(file.name);
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    // ä¿å­˜åŸå§‹å›¾ç‰‡
                    originalImage = img;
                    originalImageData = e.target.result;
                    
                    // æ˜¾ç¤ºå›¾ç‰‡é¢„è§ˆåŒºåŸŸ
                    previewContainer.classList.add('active');
                    imageInfo.classList.add('active');
                    
                    // æ˜¾ç¤ºå›¾ç‰‡é¢„è§ˆ
                    imagePreview.src = img.src;
                    
                    // æ›´æ–°å›¾ç‰‡ä¿¡æ¯
                    updateImageInfo();
                    
                    // å¯ç”¨è½¬æ¢æŒ‰é’®
                    convertBtn.disabled = false;
                    
                    // æ›´æ–°è´¨é‡æ§åˆ¶æ˜¾ç¤º
                    updateQualityControlVisibility();
                    
                    updateStatus(`å·²åŠ è½½: ${originalFileName} (${originalFormat.toUpperCase()})`);
                };
                
                img.onerror = function() {
                    updateStatus('é”™è¯¯ï¼šæ— æ³•åŠ è½½å›¾ç‰‡æ–‡ä»¶', true);
                    // é‡ç½®æ–‡ä»¶è¾“å…¥
                    fileInput.value = '';
                };
                
                img.src = e.target.result;
            };
            
            reader.onerror = function() {
                updateStatus('é”™è¯¯ï¼šæ— æ³•è¯»å–æ–‡ä»¶', true);
                // é‡ç½®æ–‡ä»¶è¾“å…¥
                fileInput.value = '';
            };
            
            reader.readAsDataURL(file);
        }
        
        // æ›´æ–°å›¾ç‰‡ä¿¡æ¯
        function updateImageInfo() {
            if (!originalImage) return;
            
            fileName.textContent = originalFileName;
            originalFormatDisplay.textContent = originalFormat.toUpperCase();
            imageDimensions.textContent = `${originalImage.width} Ã— ${originalImage.height} åƒç´ `;
            fileSizeDisplay.textContent = formatFileSize(originalFileSize);
        }
        
        // æ›´æ–°è´¨é‡æ§åˆ¶æ˜¾ç¤º
        function updateQualityControlVisibility() {
            // åªæœ‰JPEGå’ŒWEBPæ ¼å¼éœ€è¦è´¨é‡æ§åˆ¶
            if (selectedFormat === 'jpeg' || selectedFormat === 'webp') {
                qualityControl.style.display = 'block';
            } else {
                qualityControl.style.display = 'none';
            }
        }
        
        // è½¬æ¢å›¾ç‰‡
        function convertImage() {
            if (!originalImage) return;
            
            // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
            loading.style.display = 'block';
            conversionResultDiv.style.display = 'none';
            convertBtn.disabled = true;
            
            updateStatus(`æ­£åœ¨è½¬æ¢ä¸º ${selectedFormat.toUpperCase()} æ ¼å¼...`);
            
            // ä½¿ç”¨setTimeoutç¡®ä¿UIæ›´æ–°
            setTimeout(() => {
                try {
                    // åˆ›å»ºcanvas
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // è®¾ç½®canvaså°ºå¯¸
                    canvas.width = originalImage.width;
                    canvas.height = originalImage.height;
                    
                    // ç»˜åˆ¶å›¾ç‰‡åˆ°canvas
                    ctx.drawImage(originalImage, 0, 0);
                    
                    // æ ¹æ®é€‰æ‹©çš„æ ¼å¼è¿›è¡Œè½¬æ¢
                    let mimeType, dataUrl;
                    
                    switch(selectedFormat) {
                        case 'jpeg':
                            mimeType = 'image/jpeg';
                            dataUrl = canvas.toDataURL(mimeType, quality / 100);
                            break;
                        case 'png':
                            mimeType = 'image/png';
                            dataUrl = canvas.toDataURL(mimeType);
                            break;
                        case 'webp':
                            mimeType = 'image/webp';
                            // æ³¨æ„ï¼šå¹¶éæ‰€æœ‰æµè§ˆå™¨éƒ½æ”¯æŒtoDataURLçš„webpæ ¼å¼
                            try {
                                dataUrl = canvas.toDataURL(mimeType, quality / 100);
                            } catch (e) {
                                // å¦‚æœä¸æ”¯æŒwebpï¼Œä½¿ç”¨pngä½œä¸ºåå¤‡
                                updateStatus('è­¦å‘Šï¼šæ­¤æµè§ˆå™¨ä¸æ”¯æŒWEBPæ ¼å¼ï¼Œå°†ä½¿ç”¨PNGä»£æ›¿', true);
                                mimeType = 'image/png';
                                dataUrl = canvas.toDataURL(mimeType);
                                selectedFormat = 'png';
                            }
                            break;
                        case 'gif':
                            // GIFæ ¼å¼åœ¨canvasä¸­æ”¯æŒæœ‰é™ï¼Œä½¿ç”¨PNGä½œä¸ºåå¤‡
                            mimeType = 'image/gif';
                            // å°è¯•è½¬æ¢ä¸ºGIFï¼Œå¦‚æœå¤±è´¥åˆ™ä½¿ç”¨PNG
                            try {
                                // åˆ›å»ºç®€å•çš„GIFï¼ˆå•å¸§ï¼‰
                                dataUrl = canvas.toDataURL('image/gif');
                            } catch (e) {
                                updateStatus('è­¦å‘Šï¼šGIFè½¬æ¢å—é™ï¼Œä½¿ç”¨PNGæ ¼å¼ä»£æ›¿', true);
                                mimeType = 'image/png';
                                dataUrl = canvas.toDataURL(mimeType);
                                selectedFormat = 'png';
                            }
                            break;
                        case 'bmp':
                            mimeType = 'image/bmp';
                            // BMPæ ¼å¼åœ¨canvasä¸­æ”¯æŒæœ‰é™ï¼Œä½¿ç”¨PNGä½œä¸ºåå¤‡
                            try {
                                dataUrl = canvas.toDataURL('image/bmp');
                            } catch (e) {
                                updateStatus('è­¦å‘Šï¼šBMPè½¬æ¢å—é™ï¼Œä½¿ç”¨PNGæ ¼å¼ä»£æ›¿', true);
                                mimeType = 'image/png';
                                dataUrl = canvas.toDataURL(mimeType);
                                selectedFormat = 'png';
                            }
                            break;
                        case 'ico':
                            // ICOæ ¼å¼éœ€è¦ç‰¹æ®Šå¤„ç†ï¼Œè¿™é‡Œä½¿ç”¨PNGä½œä¸ºåå¤‡
                            mimeType = 'image/x-icon';
                            // ICOæ ¼å¼åœ¨canvasä¸­ä¸æ”¯æŒï¼Œä½¿ç”¨PNGä½œä¸ºåå¤‡
                            updateStatus('è­¦å‘Šï¼šICOæ ¼å¼è½¬æ¢éœ€è¦ç‰¹æ®Šå¤„ç†ï¼Œä½¿ç”¨PNGæ ¼å¼ä»£æ›¿', true);
                            mimeType = 'image/png';
                            dataUrl = canvas.toDataURL(mimeType);
                            selectedFormat = 'png';
                            break;
                        default:
                            mimeType = 'image/png';
                            dataUrl = canvas.toDataURL(mimeType);
                    }
                    
                    // ä¿å­˜è½¬æ¢ç»“æœ
                    conversionResult = dataUrl;
                    
                    // éšè—åŠ è½½åŠ¨ç”»
                    loading.style.display = 'none';
                    
                    // æ˜¾ç¤ºç»“æœ
                    showConversionResult(dataUrl, mimeType);
                    
                } catch (error) {
                    console.error('è½¬æ¢é”™è¯¯:', error);
                    updateStatus('è½¬æ¢è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ' + error.message, true);
                    loading.style.display = 'none';
                    convertBtn.disabled = false;
                }
            }, 100);
        }
        
        // æ˜¾ç¤ºè½¬æ¢ç»“æœ
        function showConversionResult(dataUrl, mimeType) {
            // æ˜¾ç¤ºç»“æœåŒºåŸŸ
            conversionResultDiv.style.display = 'block';
            
            // æ˜¾ç¤ºç»“æœå›¾ç‰‡
            resultPreview.src = dataUrl;
            
            // è®¡ç®—æ–‡ä»¶å¤§å°
            const resultSize = calculateFileSize(dataUrl);
            const resultSizeFormatted = formatFileSize(resultSize);
            
            // è®¡ç®—å‹ç¼©ç‡
            const compression = originalFileSize > 0 ? 
                ((1 - resultSize / originalFileSize) * 100).toFixed(1) : 0;
            
            // æ›´æ–°ç»“æœä¿¡æ¯
            resultFormat.textContent = selectedFormat.toUpperCase();
            resultFileSize.textContent = resultSizeFormatted;
            
            if (compression > 0) {
                compressionRatio.textContent = `å‡å°‘ ${compression}%`;
                compressionRatio.style.color = '#2ecc71';
            } else if (compression < 0) {
                compressionRatio.textContent = `å¢åŠ  ${Math.abs(compression).toFixed(1)}%`;
                compressionRatio.style.color = '#e74c3c';
            } else {
                compressionRatio.textContent = 'æ— å˜åŒ–';
                compressionRatio.style.color = '#666';
            }
            
            // é‡æ–°å¯ç”¨è½¬æ¢æŒ‰é’®ï¼ˆå¯ä»¥å†æ¬¡è½¬æ¢ï¼‰
            convertBtn.disabled = false;
            
            updateStatus(`è½¬æ¢å®Œæˆ: ${originalFormat.toUpperCase()} â†’ ${selectedFormat.toUpperCase()}, æ–°å¤§å°: ${resultSizeFormatted}`);
        }
        
        // ä¸‹è½½ç»“æœ
        function downloadResult() {
            if (!conversionResult) return;
            
            // ç”Ÿæˆæ–‡ä»¶å
            const baseName = originalFileName.substring(0, originalFileName.lastIndexOf('.'));
            const newFileName = `${baseName}_converted.${selectedFormat}`;
            
            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const link = document.createElement('a');
            link.download = newFileName;
            link.href = conversionResult;
            link.click();
            
            updateStatus(`å·²ä¸‹è½½: ${newFileName}`);
        }
        
        // é‡ç½®è½¬æ¢
        function resetConversion() {
            // éšè—ç»“æœåŒºåŸŸ
            conversionResultDiv.style.display = 'none';
            
            // é‡ç½®ç»“æœé¢„è§ˆ
            resultPreview.src = '';
            
            updateStatus('å·²é‡ç½®ï¼Œå¯ä»¥å¼€å§‹æ–°çš„è½¬æ¢');
        }
        
        // è¾…åŠ©å‡½æ•°ï¼šè·å–æ–‡ä»¶æ‰©å±•å
        function getFileExtension(filename) {
            return filename.slice((filename.lastIndexOf(".") - 1 >>> 0) + 2).toLowerCase();
        }
        
        // è¾…åŠ©å‡½æ•°ï¼šæ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // è¾…åŠ©å‡½æ•°ï¼šè®¡ç®—DataURLçš„æ–‡ä»¶å¤§å°
        function calculateFileSize(dataUrl) {
            // å‡å»DataURLå‰ç¼€çš„å¤§å°
            const prefix = 'data:image/png;base64,'.length;
            const base64 = dataUrl.substring(dataUrl.indexOf(',') + 1);
            
            // Base64ç¼–ç ä¼šå¢åŠ çº¦33%çš„å¤§å°
            // è®¡ç®—å…¬å¼ï¼šåŸå§‹å¤§å° = base64é•¿åº¦ * 3/4 - paddingç­‰
            let size = base64.length;
            
            // å‡å»paddingç­‰
            if (base64.endsWith('==')) {
                size -= 2;
            } else if (base64.endsWith('=')) {
                size -= 1;
            }
            
            // è®¡ç®—åŸå§‹å­—èŠ‚å¤§å°
            return Math.floor(size * 3 / 4);
        }
        
        // æ›´æ–°çŠ¶æ€æ 
        function updateStatus(message, isError = false) {
            statusMessage.textContent = message;
            
            if (isError) {
                statusBar.style.backgroundColor = '#ffebee';
                statusBar.style.color = '#c62828';
                statusBar.style.borderTop = '1px solid #ffcdd2';
            } else {
                statusBar.style.backgroundColor = '#e8f4fd';
                statusBar.style.color = '#0d47a1';
                statusBar.style.borderTop = '1px solid #d1e3f8';
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>